import { GoogleGenAI } from "@google/genai";
import { GEMINI_MODEL } from '../constants';

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

export const getPhysicsHelp = async (
  query: string, 
  context: { v0: number; vt: number; t: number; c: number }
): Promise<string> => {
  if (!process.env.API_KEY) return "API Key not found. Please check your environment configuration.";

  try {
    const systemInstruction = `
      You are an expert Physics Laboratory Assistant for a university-level experiment on "High Resistance Measurement by Leakage Method".
      
      Current Experiment Context:
      - Initial Voltage (V0): ${context.v0} V
      - Current Voltage (Vt): ${context.vt} V
      - Time Elapsed (t): ${context.t} s
      - Capacitor (C): ${context.c} ÂµF

      The formula is: R = t / (C * ln(V0 / Vt)).
      Note: C is in Microfarads (1e-6 F). Result R will be in Ohms. Convert to MegaOhms for display usually.

      Your goal is to guide the student. Do not just give the answer directly unless asked to verify a calculation.
      Explain the physical concepts (exponential decay, RC time constant, leakage current) when asked.
      Keep responses concise and helpful.
    `;

    const response = await ai.models.generateContent({
      model: GEMINI_MODEL,
      contents: query,
      config: {
        systemInstruction: systemInstruction,
      }
    });

    return response.text || "I couldn't generate a response. Please try again.";
  } catch (error) {
    console.error("Gemini API Error:", error);
    return "Sorry, I am having trouble connecting to the physics database right now.";
  }
};
